name: Windows Released-Binary Integration

on:
  workflow_run:
    workflows:
      - Build Release
    types:
      - completed
  issue_comment:
    types:
      - created

permissions:
  contents: read
  actions: read

jobs:
  integration:
    name: Run Integration on Windows VM
    runs-on: windows-latest
    timeout-minutes: 60
    if: >-
      (github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-integration-test') &&
      (github.event.comment.author_association == 'OWNER' ||
      github.event.comment.author_association == 'MEMBER' ||
      github.event.comment.author_association == 'COLLABORATOR'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/merge', github.event.issue.number) || github.event.workflow_run.head_sha }}

      - name: Setup go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download gorilla.exe from Build Release run artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}
          name: gorilla-exe-release
          path: ${{ runner.temp }}/gorilla-artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build gorilla.exe from PR merge ref
        if: github.event_name == 'issue_comment'
        shell: pwsh
        run: |
          $outDir = "${{ runner.temp }}\gorilla-binary"
          New-Item -Path $outDir -ItemType Directory -Force | Out-Null
          go build -v -o "$outDir\gorilla.exe" ./cmd/gorilla

      - name: Resolve gorilla.exe path
        shell: pwsh
        run: |
          $candidate1 = "${{ runner.temp }}\gorilla-artifact\gorilla.exe"
          $candidate2 = "${{ runner.temp }}\gorilla-binary\gorilla.exe"

          if (Test-Path -LiteralPath $candidate1) {
            "GORILLA_EXE_PATH=$candidate1" >> $env:GITHUB_ENV
            exit 0
          }

          if (Test-Path -LiteralPath $candidate2) {
            "GORILLA_EXE_PATH=$candidate2" >> $env:GITHUB_ENV
            exit 0
          }

          throw "Unable to resolve gorilla.exe path"

      - name: Run released-binary integration harness
        shell: pwsh
        run: |
          ./integration/windows/run-release-integration.ps1 `
            -GorillaExePath "$env:GORILLA_EXE_PATH"
