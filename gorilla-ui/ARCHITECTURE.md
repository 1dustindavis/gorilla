# Gorilla UI Architecture (v0)

## Objectives
- Run Gorilla UI as a standard user process.
- Communicate with Gorilla service over named pipes.
- Provide first-release capabilities:
  - List available `option_installs`
  - Install item
  - Remove item
  - Stream install/remove status

## Layout
- `gorilla-ui/src/Gorilla.UI.App/` WinUI 3 app project (Windows VM scaffold target)
- `gorilla-ui/src/Gorilla.UI.Client/` pipe client + contracts
- `gorilla-ui/tests/Gorilla.UI.Client.Tests/` client contract and protocol tests
- `gorilla-ui/tools/PipeHarness/` CLI harness for pipe protocol validation
- `gorilla-ui/docs/` protocol examples and notes

## Named Pipe Contract

### Transport
- Pipe name: `gorilla-service`
- Encoding: UTF-8 JSON
- Framing: one JSON message per line (newline-delimited JSON)
- Request/response operations are line-delimited envelopes.
- `StreamOperationStatus` returns a line-delimited stream of status envelopes until completion/failure/cancel.
- Service flushes pipe buffers before disconnecting a client connection to reduce dropped terminal envelopes.

### Envelope
All messages use this base shape:

```json
{
  "version": "v1",
  "messageType": "Request|Response|Event|Error",
  "operation": "ListOptionalInstalls|InstallItem|RemoveItem|StreamOperationStatus",
  "requestId": "uuid",
  "operationId": "uuid-or-empty",
  "timestampUtc": "2026-02-14T18:10:00Z",
  "payload": {}
}
```

Notes:
- `requestId` correlates one request to one response.
- `operationId` correlates one install/remove operation to status events.
- `operationId` is generated by service in `InstallItem`/`RemoveItem` response.

## Operations
- `ListOptionalInstalls`
  - Request payload: optional filters/sorting later; empty for v0.
  - Response payload: list of available items and current state metadata.
  - Important: return only a JSON-safe subset of item fields. Do not emit full internal item objects because some fields may not be JSON-compatible.
  - Item identity and details should align with existing Gorilla YAML concepts:
    - `itemName` (from `item_name`)
    - `displayName` (from `display_name`)
    - `version`
    - `catalog`
    - `installerType`, `installerPackageId`, `installerLocation` (installer summary fields)
  - Required item status fields in v0:
    - `isInstalled` (bool): current installed state.
    - `status` (string enum): `Installed|NotInstalled|InstallPending|RemovePending|Unknown`.
    - `statusUpdatedAtUtc` (RFC3339 timestamp): last known status update time.
    - `lastOperationId` (string, optional): most recent related install/remove operation.
- `InstallItem`
  - Request payload: `itemName`.
  - Response payload: accepted status + `operationId`.
- `RemoveItem`
  - Request payload: `itemName`.
  - Response payload: accepted status + `operationId`.
- `StreamOperationStatus`
  - Request payload: `operationId`.
  - Response payload: initial ack.
  - Followed by `Event` messages with status/progress until terminal state.

## Status State Machine (Install/Remove)

### States
- `Queued`
- `Validating`
- `Downloading`
- `Installing` or `Removing`
- `Succeeded` (terminal)
- `Failed` (terminal)
- `Canceled` (terminal)

### Rules
- Terminal states are immutable.
- Progress (`progressPercent`) must be monotonic within an operation.
- `Failed` includes `errorCode` and `errorMessage`.
- `Canceled` includes `canceledBy` (`user|service|system`).

## UI Screen Map
- Home (default):
  - Store-like hero + cards for available items.
  - Each card shows current state and primary action (`Install` or `Remove`).
- Item detail panel/page:
  - Description, version, status, last action result.
  - Action button and inline operation feedback.
- Activity view:
  - Active and recent operations with status timeline.
  - Text stream for detailed status lines (first release can be simple).

## User Flows
- Startup load flow (cache-first):
  1. On app start, load the most recent cached `ListOptionalInstalls` result from local disk.
  2. Immediately render cached items so first paint is fast and usable offline.
  3. Immediately request fresh data via `ListOptionalInstalls`.
  4. Replace/update UI with fresh response and overwrite cache.
  5. If refresh fails, keep cached results visible and show non-blocking stale-data/service warning.
- Install flow:
  1. UI loads items via `ListOptionalInstalls`.
  2. User selects `Install`.
  3. UI calls `InstallItem`, receives `operationId`.
  4. UI opens `StreamOperationStatus` for that `operationId`.
  5. UI updates item + activity views until terminal status.
- Remove flow:
  1. UI loads items via `ListOptionalInstalls`.
  2. User selects `Remove`.
  3. UI calls `RemoveItem`, receives `operationId`.
  4. UI opens `StreamOperationStatus` for that `operationId`.
  5. UI updates item + activity views until terminal status.

## Error Handling
- Pipe unavailable: show service unavailable banner + retry action.
- Timeout: show retry option and keep activity record.
- Protocol mismatch (`version` unsupported): hard error with compatibility message.
- Unexpected stream end before terminal state: mark operation as `Failed` with `stream_ended`.
- Cache read failure: log warning and continue with live request.
- Cache write failure: log warning and continue; do not block UI.

## Diagnostics Decision Record

### Policy Matrix
| Area | Default | Debug Enablement | Verbose Enablement | Notes |
| --- | --- | --- | --- | --- |
| UI client diagnostics (`ClientDiagnostics`) | Disabled | `GORILLA_UI_DEBUG=1` or `GORILLA_DEBUG=1` | N/A | No diagnostics directory/file is created when disabled. |
| Service named-pipe trace diagnostics (`gorillalog.Debug` in service pipe paths) | Disabled | `debug: true` in config or `--debug` | N/A | High-volume pipe request/response tracing remains debug-only. |
| Gorilla process baseline logs (`gorillalog.Info/Warn/Error`) | Enabled | Still enabled | `verbose: true` or `--verbose` adds console output | Baseline troubleshooting logs stay enabled in both service mode and CLI mode. |

### Log Paths and Creation Rules
- UI client (Windows runtime): `%LOCALAPPDATA%\\gorilla\\ui-client.log`.
- Gorilla process log (service mode and CLI mode): `<app_data_path>/gorilla.log` (defaults to `%ProgramData%\\gorilla\\gorilla.log` when `app_data_path` is not set).
- Creation rules:
  - UI diagnostics directory/file are created only when UI diagnostics are enabled.
  - Service log directory/file are created at service logger initialization except in `checkonly` mode.
  - No additional per-operation files are created.

### Retention and Rotation Policy
- Target policy:
  - Keep `gorilla.log` and `ui-client.log` bounded to `10 MiB` each.
  - Rotate by rename (`*.log` -> `*.log.1`) when exceeding cap, keep one backup.
  - Trigger cleanup at process startup and before first append after crossing cap.
- Failure behavior:
  - If rotation/cleanup fails, continue operating and keep logging best-effort.
  - Diagnostics/logging failures must never fail install/remove/list service operations.

### Required Correlation Fields
- Required fields for cross-process troubleshooting on protocol/operation lifecycle logs:
  - `requestId`
  - `operationId`
  - `operation` (API action name)
  - `state` (operation state)
  - `result` (`ok|error|canceled`)
  - `durationMs` (when measurable)
- UI and service lifecycle logs should include these fields whenever the value exists for the event.

### Implementation Mapping and Deferred Tasks
- `pkg/gorillalog/gorillalog.go`
  - Implemented: bounded file retention/rotation for `gorilla.log` (single backup: `gorilla.log.1`).
  - Deferred: structured key/value helper API to avoid ad hoc string formatting in call sites.
- `pkg/service/run_windows.go`
  - Implemented: request lifecycle diagnostics with explicit `operation`, `requestId`, `operationId`, `result`, and `durationMs`.
  - Deferred: add explicit `state` transitions beyond terminal lifecycle markers.
- `gorilla-ui/src/Gorilla.UI.Client/ClientDiagnostics.cs`
  - Implemented: retention/rotation for `ui-client.log` (single backup: `ui-client.log.1`).
  - Deferred: normalize all diagnostics lines to one schema; currently enforced for request/stream lifecycle lines.

### Rationale
- Keep diagnostics noise low by default while preserving current service operational logging behavior needed for support.
- Keep high-volume tracing behind explicit debug toggles.
- Standardize correlation fields so UI and service events can be joined during incident triage.

## Immediate Build Notes
- WinUI project creation/build happens on Windows VM.
- This repo can still host shared contracts, docs, and harness code from macOS.
- `cmd/gorilla` CLI commands that talk to the service should be treated as a first-class debug client and updated in lockstep with this API design.
- Existing CLI message compatibility is not a requirement for this iteration.
