# Gorilla UI Architecture (v0)

## Objectives
- Run Gorilla UI as a standard user process.
- Communicate with Gorilla service over named pipes.
- Provide first-release capabilities:
  - List available `option_installs`
  - Install item
  - Remove item
  - Stream install/remove status

## Layout
- `gorilla-ui/src/Gorilla.UI.App/` WinUI 3 app project (Windows VM scaffold target)
- `gorilla-ui/src/Gorilla.UI.Client/` pipe client + contracts
- `gorilla-ui/tests/Gorilla.UI.Client.Tests/` client contract and protocol tests
- `gorilla-ui/tools/PipeHarness/` CLI harness for pipe protocol validation
- `gorilla-ui/docs/` protocol examples and notes

## Named Pipe Contract

### Transport
- Pipe name: `gorilla-service`
- Encoding: UTF-8 JSON
- Framing: one JSON message per line (newline-delimited JSON)
- Request/response operations are line-delimited envelopes.
- `StreamOperationStatus` returns a line-delimited stream of status envelopes until completion/failure/cancel.

### Envelope
All messages use this base shape:

```json
{
  "version": "v1",
  "messageType": "Request|Response|Event|Error",
  "operation": "ListOptionalInstalls|InstallItem|RemoveItem|StreamOperationStatus",
  "requestId": "uuid",
  "operationId": "uuid-or-empty",
  "timestampUtc": "2026-02-14T18:10:00Z",
  "payload": {}
}
```

Notes:
- `requestId` correlates one request to one response.
- `operationId` correlates one install/remove operation to status events.
- `operationId` is generated by service in `InstallItem`/`RemoveItem` response.

## Operations
- `ListOptionalInstalls`
  - Request payload: optional filters/sorting later; empty for v0.
  - Response payload: list of available items and current state metadata.
  - Important: return only a JSON-safe subset of item fields. Do not emit full internal item objects because some fields may not be JSON-compatible.
  - Item identity and details should align with existing Gorilla YAML concepts:
    - `itemName` (from `item_name`)
    - `displayName` (from `display_name`)
    - `version`
    - `catalog`
    - `installerType`, `installerPackageId`, `installerLocation` (installer summary fields)
  - Required item status fields in v0:
    - `isInstalled` (bool): current installed state.
    - `status` (string enum): `Installed|NotInstalled|InstallPending|RemovePending|Unknown`.
    - `statusUpdatedAtUtc` (RFC3339 timestamp): last known status update time.
    - `lastOperationId` (string, optional): most recent related install/remove operation.
- `InstallItem`
  - Request payload: `itemName`.
  - Response payload: accepted status + `operationId`.
- `RemoveItem`
  - Request payload: `itemName`.
  - Response payload: accepted status + `operationId`.
- `StreamOperationStatus`
  - Request payload: `operationId`.
  - Response payload: initial ack.
  - Followed by `Event` messages with status/progress until terminal state.

## Status State Machine (Install/Remove)

### States
- `Queued`
- `Validating`
- `Downloading`
- `Installing` or `Removing`
- `Succeeded` (terminal)
- `Failed` (terminal)
- `Canceled` (terminal)

### Rules
- Terminal states are immutable.
- Progress (`progressPercent`) must be monotonic within an operation.
- `Failed` includes `errorCode` and `errorMessage`.
- `Canceled` includes `canceledBy` (`user|service|system`).

## UI Screen Map
- Home (default):
  - Store-like hero + cards for available items.
  - Each card shows current state and primary action (`Install` or `Remove`).
- Item detail panel/page:
  - Description, version, status, last action result.
  - Action button and inline operation feedback.
- Activity view:
  - Active and recent operations with status timeline.
  - Text stream for detailed status lines (first release can be simple).

## User Flows
- Startup load flow (cache-first):
  1. On app start, load the most recent cached `ListOptionalInstalls` result from local disk.
  2. Immediately render cached items so first paint is fast and usable offline.
  3. Immediately request fresh data via `ListOptionalInstalls`.
  4. Replace/update UI with fresh response and overwrite cache.
  5. If refresh fails, keep cached results visible and show non-blocking stale-data/service warning.
- Install flow:
  1. UI loads items via `ListOptionalInstalls`.
  2. User selects `Install`.
  3. UI calls `InstallItem`, receives `operationId`.
  4. UI opens `StreamOperationStatus` for that `operationId`.
  5. UI updates item + activity views until terminal status.
- Remove flow:
  1. UI loads items via `ListOptionalInstalls`.
  2. User selects `Remove`.
  3. UI calls `RemoveItem`, receives `operationId`.
  4. UI opens `StreamOperationStatus` for that `operationId`.
  5. UI updates item + activity views until terminal status.

## Error Handling
- Pipe unavailable: show service unavailable banner + retry action.
- Timeout: show retry option and keep activity record.
- Protocol mismatch (`version` unsupported): hard error with compatibility message.
- Unexpected stream end before terminal state: mark operation as `Failed` with `stream_ended`.
- Cache read failure: log warning and continue with live request.
- Cache write failure: log warning and continue; do not block UI.

## Logging
- Both UI and service log: `requestId`, `operationId`, `operation`, `state`, `durationMs`, `result`.
- First release keeps logs local and human-readable for support.

## Immediate Build Notes
- WinUI project creation/build happens on Windows VM.
- This repo can still host shared contracts, docs, and harness code from macOS.
- `cmd/gorilla` CLI commands that talk to the service should be treated as a first-class debug client and updated in lockstep with this API design.
- Existing CLI message compatibility is not a requirement for this iteration.
