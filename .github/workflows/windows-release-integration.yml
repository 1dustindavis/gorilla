name: Windows Released-Binary Integration

on:
  workflow_run:
    workflows:
      - Build Release
    types:
      - completed
  issue_comment:
    types:
      - created

permissions:
  contents: read
  actions: read
  checks: write
  issues: write
  pull-requests: write

jobs:
  integration:
    name: Run Integration on Windows VM
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      INTEGRATION_WORK_ROOT: ${{ runner.temp }}\gorilla-release-integration
    if: >-
      (github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/run-integration-test') &&
      (github.event.comment.author_association == 'OWNER' ||
      github.event.comment.author_association == 'MEMBER' ||
      github.event.comment.author_association == 'COLLABORATOR'))

    steps:
      - name: Resolve PR head sha
        if: github.event_name == 'issue_comment'
        id: pr_meta
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;
            const pr = await github.rest.pulls.get({ owner, repo, pull_number });
            core.setOutput("head_sha", pr.data.head.sha);

      - name: Create in-progress check run
        if: github.event_name == 'issue_comment'
        id: check_start
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const response = await github.rest.checks.create({
              owner,
              repo,
              name: "Windows Released-Binary Integration",
              head_sha: "${{ steps.pr_meta.outputs.head_sha }}",
              status: "in_progress",
              details_url: runUrl,
              output: {
                title: "Integration test started",
                summary: `Triggered by @${context.payload.comment.user.login} via /run-integration-test.\n\nRun: ${runUrl}`
              }
            });
            core.setOutput("check_run_id", String(response.data.id));

      - name: Comment start on PR
        if: github.event_name == 'issue_comment'
        id: comment_start
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const comment = await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: context.issue.number,
              body: [
                "<!-- gorilla-integration-status -->",
                "Windows integration test started from `/run-integration-test`.",
                "",
                `Run: ${runUrl}`
              ].join("\n")
            });
            core.setOutput("comment_id", String(comment.data.id));

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/merge', github.event.issue.number) || github.event.workflow_run.head_sha }}

      - name: Setup go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download gorilla.exe from Build Release run artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}
          name: gorilla-exe-release
          path: ${{ runner.temp }}/gorilla-artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build gorilla.exe from PR merge ref
        if: github.event_name == 'issue_comment'
        shell: pwsh
        run: |
          $outDir = "${{ runner.temp }}\gorilla-binary"
          New-Item -Path $outDir -ItemType Directory -Force | Out-Null
          go build -v -o "$outDir\gorilla.exe" ./cmd/gorilla

      - name: Resolve gorilla.exe path
        shell: pwsh
        run: |
          $candidate1 = "${{ runner.temp }}\gorilla-artifact\gorilla.exe"
          $candidate2 = "${{ runner.temp }}\gorilla-binary\gorilla.exe"

          if (Test-Path -LiteralPath $candidate1) {
            "GORILLA_EXE_PATH=$candidate1" >> $env:GITHUB_ENV
            exit 0
          }

          if (Test-Path -LiteralPath $candidate2) {
            "GORILLA_EXE_PATH=$candidate2" >> $env:GITHUB_ENV
            exit 0
          }

          throw "Unable to resolve gorilla.exe path"

      - name: Prepare released-binary integration fixtures
        shell: pwsh
        run: |
          ./integration/windows/prepare-release-integration.ps1 `
            -WorkRoot "${{ env.INTEGRATION_WORK_ROOT }}"

      - name: Run released-binary integration tests
        shell: pwsh
        run: |
          ./integration/windows/run-release-integration.ps1 `
            -WorkRoot "${{ env.INTEGRATION_WORK_ROOT }}" `
            -GorillaExePath "$env:GORILLA_EXE_PATH"

      - name: Finalize check run
        if: always() && github.event_name == 'issue_comment' && steps.check_start.outputs.check_run_id != ''
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const status = "${{ job.status }}";
            let conclusion = "failure";
            if (status === "success") conclusion = "success";
            if (status === "cancelled") conclusion = "cancelled";
            if (status === "skipped") conclusion = "neutral";

            await github.rest.checks.update({
              owner,
              repo,
              check_run_id: Number("${{ steps.check_start.outputs.check_run_id }}"),
              status: "completed",
              conclusion,
              details_url: runUrl,
              output: {
                title: `Integration ${conclusion}`,
                summary: `Workflow completed with status: ${status}.\n\nRun: ${runUrl}`
              }
            });

      - name: Finalize PR comment
        if: always() && github.event_name == 'issue_comment' && steps.comment_start.outputs.comment_id != ''
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const status = "${{ job.status }}";
            const state = status === "success" ? "passed" : (status === "cancelled" ? "was cancelled" : "failed");
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: Number("${{ steps.comment_start.outputs.comment_id }}"),
              body: [
                "<!-- gorilla-integration-status -->",
                `Windows integration test ${state}.`,
                "",
                `Run: ${runUrl}`
              ].join("\n")
            });
